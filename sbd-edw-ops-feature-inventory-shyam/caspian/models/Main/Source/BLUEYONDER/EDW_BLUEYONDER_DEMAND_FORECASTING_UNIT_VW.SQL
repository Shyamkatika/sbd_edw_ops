WITH DFU as (
  select distinct
UPPER(CONCAT(COALESCE(DFU.DMDUNIT::VARCHAR,''),'~',COALESCE(DFU.DMDGROUP::VARCHAR,''), '~', COALESCE(DFU.LOC::VARCHAR,''),'~',
COALESCE(DFU.MODEL::VARCHAR,''))) AS DMD_FORCAST_UNIT_KEY,
'BLUEYONDER' as  {{var('column_srcsyskey')}},  
MD5(UPPER(CONCAT(COALESCE(DFU.DMDUNIT::VARCHAR,''),'~',COALESCE(DFU.DMDGROUP::VARCHAR,''),'~', COALESCE(DFU.LOC::VARCHAR,''),'~',
COALESCE(DFU.MODEL::VARCHAR,'')))) AS {{var('column_rechashkey')}},
{{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
'{{model.name}}' as {{var('column_ETL_INS_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_INS_DTE')}},
'{{model.name}}' as {{var('column_ETL_UPD_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_UPD_DTE')}},
DFU.LOADDTS as {{var('column_z3loddtm')}},
DFU.LOADDTS as  {{var('column_vereffdte')}},
'9999-12-31 00:00:00.000' as {{var('column_verexpirydt')}},
{{var('default_y')}} AS  {{var('column_currrecflag')}},                                                                                    
{{var('default_n')}} AS  {{var('column_orprecflag')}},
LOC as LOC_KEY,
HISTSTART as  HIST_START_DTE,
EFF  as DFU_EFF_START_DTE,
DISC as DFU_DSCTU_DTE,
DMDPOSTDATE as DMD_POST_DTE,
MODELDATE as MODEL_RUN_DTE,
PUBLISHDATE as FCST_PUBLISHED_DTE,
ADJDMDPOSTDATE as ADJ_DMD_POST_DTE,
DMDGROUP as DMD_GRP, 
REFITDATE as MODEL_REFIT_DTE,
U_NEW_DATE as DFU_FIRST_CREATE_DTE,
U_NEW_DATE     as DFU_CREATE_DTE,
NULL as FIRST_ENTR_PRC,
SYMMETRICMAPE as MEAN_ABSOLUTE_ERR_PCT,
STATMSE as STATS_MODEL_ACCURACY_VAL,
INITE3ERROR as INIT_E3_ERR_VAL,
E3ERROR as FINAL_E3_ERR_VAL,
U_PLANNERCODE as DMD_PLNR_USER,
  NULL as PRC_PRFL_NAME,  
U_DFU_LVL as DFU_LVL,
DMDUNIT  as DMD_UNIT_KEY,
MODEL as MODEL_TYP,
U_NEW_DFU as DFU_NEW_FLAG,
DMDCAL as DMDCAL, 
FCSTHOR as FCST_HRZN,
SEASONPROFILE as SESN_PRFL,
COPYDATE as COPY_DTE,
COPYFROMDMDGROUP as  COPY_FRM_DMD_GRP,
COPYFROMDMDUNIT as  COPY_FRM_DMD_UNIT,
COPYFROMLOC as  COPY_FRM_LOC,
COPYFROMMODEL as COPY_FRM_MODL,
U_CALC_MDL_FLG as CALC_MDL_FLAG,
U_D2S as DFU_To_SKU_FLAG,
U_DFU_STS as DFU_STS_FLAG,
U_PUB_FLG as DFU_PUB_FLAG,
U_RECON_LVL_4 as RECON_LVL_FLAG, 
NULL as PUB_TRGT_DFU_FLAG,
NULL as DIV,
NULL as MSRP,
NULL as DFUVIEW_NEW_FLAG
FROM {{source('BLUEYONDER','DFU')}} DFU
order by     DMDUNIT,DMDGROUP,LOC,MODEL
  ), 

DFUVIEW as (
  select distinct
UPPER(CONCAT(COALESCE(DFUVIEW.DMDUNIT::VARCHAR,''),'~',
COALESCE(DFUVIEW.DMDGROUP::VARCHAR,''),'~',
COALESCE(DFUVIEW.LOC::VARCHAR,''))) AS DMD_FORCAST_UNIT_KEY,
'BLUEYONDER' as  {{var('column_srcsyskey')}},  
MD5(UPPER(CONCAT(COALESCE(DFUVIEW.DMDUNIT::VARCHAR,''),'~',COALESCE(DFUVIEW.DMDGROUP::VARCHAR,''),'~',
COALESCE(DFUVIEW.LOC::VARCHAR,'')))) AS {{var('column_rechashkey')}},
{{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
'{{model.name}}' as {{var('column_ETL_INS_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_INS_DTE')}},
'{{model.name}}' as {{var('column_ETL_UPD_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_UPD_DTE')}},
DFUVIEW.LOADDTS as {{var('column_z3loddtm')}},
DFUVIEW.LOADDTS as  {{var('column_vereffdte')}},
'9999-12-31 00:00:00.000' as {{var('column_verexpirydt')}},
{{var('default_y')}} AS  {{var('column_currrecflag')}},                                                                                    
{{var('default_n')}} AS  {{var('column_orprecflag')}},
LOC as LOC_KEY,
NULL as  HIST_START_DTE,
NULL as DFU_EFF_START_DTE,
NULL as DFU_DSCTU_DTE,
NULL  as DMD_POST_DTE,
NULL as MODEL_RUN_DTE,
NULL as FCST_PUBLISHED_DTE,
NULL as ADJ_DMD_POST_DTE,
DMDGROUP as DMD_GRP, 
NULL as MODEL_REFIT_DTE,
NULL as DFU_FIRST_CREATE_DTE,
NULL     as DFU_CREATE_DTE,
U_SALE_PRICE as FIRST_ENTR_PRC,
NULL as MEAN_ABSOLUTE_ERR_PCT,
NULL as STATS_MODEL_ACCURACY_VAL,
NULL as INIT_E3_ERR_VAL,
NULL as FINAL_E3_ERR_VAL,
NULL as DMD_PLNR_USER,
PRICEPROFILENAME as PRC_PRFL_NAME,    
U_DFU_LVL as DFU_LVL,
DMDUNIT  as DMD_UNIT_KEY,
  NULL as MODEL_TYP,
NULL  as DFU_NEW_FLAG,
NULL as DMDCAL, 
NULL as FCST_HRZN,
NULL as SESN_PRFL,
NULL as COPY_DTE,
NULL as  COPY_FRM_DMD_GRP,
NULL as  COPY_FRM_DMD_UNIT,
NULL as  COPY_FRM_LOC,
NULL as COPY_FRM_MODL,
NULL as CALC_MDL_FLAG,
NULL as DFU_To_SKU_FLAG,
NULL as DFU_STS_FLAG,
NULL as DFU_PUB_FLAG,
NULL as RECON_LVL_FLAG,
U_PUB_TARGET_DFU  as PUB_TRGT_DFU_FLAG,
U_DIV as DIV,
U_MSRP as MSRP,
U_NEW_DFUVIEW as DFUVIEW_NEW_FLAG
FROM {{source('BLUEYONDER','DFUVIEW')}} DFUVIEW
order by DMDUNIT,DMDGROUP,LOC
  ), 
map as (
  select * from DFU 
    union all 
  select * from DFUVIEW
  )
select distinct * from map