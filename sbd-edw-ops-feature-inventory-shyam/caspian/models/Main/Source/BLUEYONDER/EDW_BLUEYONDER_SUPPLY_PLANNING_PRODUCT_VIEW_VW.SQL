WITH SKU as (
select
UPPER(CONCAT(COALESCE(SKU.ITEM::VARCHAR,''),'~',COALESCE(SKU.LOC::VARCHAR,''))) AS SUPPLY_PLNG_PROD_VW_KEY,
'BLUEYONDER' as  {{var('column_srcsyskey')}},  
MD5(UPPER(CONCAT(COALESCE(SKU.ITEM::VARCHAR,''),'~',COALESCE(SKU.LOC::VARCHAR,'')))) AS {{var('column_rechashkey')}},
{{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
'{{model.name}}' as {{var('column_ETL_INS_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_INS_DTE')}},
'{{model.name}}' as {{var('column_ETL_UPD_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_UPD_DTE')}},
SKU.LOADDTS as {{var('column_z3loddtm')}},
SKU.LOADDTS as  {{var('column_vereffdte')}},
'9999-12-31 00:00:00.000' as {{var('column_verexpirydt')}},
{{var('default_y')}} AS  {{var('column_currrecflag')}},                                                                                    
{{var('default_n')}} AS  {{var('column_orprecflag')}},
NULL as   BKORD_QTY, 
ITEM as PROD_KEY,
U_DEFAULT_COST as STD_COST,
NULL as VEND_NBR,
NULL as SKU_ID_NBR,
NULL as AGRT_GRS_REQ_QTY,
NULL as SKU_BUYER_NAME,
NULL as SKU_FAMILY_CD_NBR,
NULL as SKU_ISS_POLICY,
NULL as SKU_PROD_GRP,
NULL as LABR_HRS_NBR,
NULL as SKU_PROD_TYP,
NULL as ACT_ON_ORD_QTY,
NULL as SKU_CD_PLNR,
CASE WHEN U_DELETE=0 then 'N' else 'Y' end as DEL_FLAG,
U_NEW_SKU as NEW_TO_JDA,
LOC as LOC_KEY,
MPBATCHNUM as BATCH_NBR,
ITEMSTOREGRADE as SKU_STORE_GRADE,
REPLENMETHOD as REPL_MTHD_TYP,
CREATIONDATE as  SKU_CREATE_DTE,
OHPOST as  LAST_ON_HAND_POST_DTE,
NPITRANSDUR as TRANSITION_PHASE_DUR_DY_CNT,
CASE WHEN STORABLESW=0 then 'N' else 'Y' end  as STORABLE_PROD_FLAG,
OH as ON_HAND_QTY,
CASE WHEN NETCHGSW=0 then 'N' else 'Y' end  as NET_SKU_CHG_FLAG,
REPLENTYPE as SKU_REPL_PLAN,
PLANLEVEL as  SKU_PLAN_LVL,
SOURCINGGROUP as SKU_SOURCING_GRP_ID,
QTYUOM as SKU_UOM_QTY,
CASE WHEN U_D2S=0 then 'N' else 'Y' end  as DFU_To_SKU_FLAG,
U_ITEMCLASS as ABC_CLS_LKEY
FROM {{source('BLUEYONDER','SKU')}} SKU
),

SKUDISPLAY as (
select
UPPER(CONCAT(COALESCE(SKUDISPLAY.ITEM::VARCHAR,''),'~',COALESCE(SKUDISPLAY.LOC::VARCHAR,''))) AS SUPPLY_PLNG_PROD_VW_KEY,
'BLUEYONDER' as  {{var('column_srcsyskey')}},  
MD5(UPPER(CONCAT(COALESCE(SKUDISPLAY.ITEM::VARCHAR,''),'~',COALESCE(SKUDISPLAY.LOC::VARCHAR,'')))) AS {{var('column_rechashkey')}},
{{var('default_n')}} as {{var('column_DEL_FROM_SRC_FLAG')}},
'{{model.name}}' as {{var('column_ETL_INS_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_INS_DTE')}},
'{{model.name}}' as {{var('column_ETL_UPD_PID')}},
CURRENT_TIMESTAMP::TIMESTAMP_NTZ as {{var('column_ETL_UPD_DTE')}},
SKUDISPLAY.LOADDTS as {{var('column_z3loddtm')}},
SKUDISPLAY.LOADDTS as  {{var('column_vereffdte')}},
'9999-12-31 00:00:00.000' as {{var('column_verexpirydt')}},
{{var('default_y')}} AS  {{var('column_currrecflag')}},                                                                                    
{{var('default_n')}} AS  {{var('column_orprecflag')}},
BACKORDERQTY as   BKORD_QTY, 
ITEM as PROD_KEY,
NULL as STD_COST,
VENDOR as VEND_NBR,
ABBR as SKU_ID_NBR,
AGRORI as AGRT_GRS_REQ_QTY,
BUYER as SKU_BUYER_NAME,
FAMILY as SKU_FAMILY_CD_NBR,
ISSUE as SKU_ISS_POLICY,
ITEMGROUP as SKU_PROD_GRP,
LABHR as LABR_HRS_NBR,
MTYPE as SKU_PROD_TYP,
ONORDERQTY as ACT_ON_ORD_QTY,
PLANNER as SKU_CD_PLNR,
'U' as DEL_FLAG,
NULL as NEW_TO_JDA,
LOC as LOC_KEY,
NULL as BATCH_NBR,
NULL as SKU_STORE_GRADE,
NULL as REPL_MTHD_TYP,
NULL as  SKU_CREATE_DTE,
NULL as  LAST_ON_HAND_POST_DTE,
NULL as TRANSITION_PHASE_DUR_DY_CNT,
'U' as STORABLE_PROD_FLAG,
NULL as ON_HAND_QTY,
'U' as NET_SKU_CHG_FLAG,
NULL as SKU_REPL_PLAN,
NULL as  SKU_PLAN_LVL,
NULL as SKU_SOURCING_GRP_ID,
NULL as SKU_UOM_QTY,
'N' as DFU_To_SKU_FLAG,
NULL as ABC_CLS_LKEY
FROM {{source('BLUEYONDER','SKUDISPLAY')}} SKUDISPLAY
), 
map as (
select * from SKU
   union all 
   (select * from SKUDISPLAY SD
   where not exists 
    (select SUPPLY_PLNG_PROD_VW_KEY from SKU S
    where SD.SUPPLY_PLNG_PROD_VW_KEY =S.SUPPLY_PLNG_PROD_VW_KEY))
)
select * from map